{"version":3,"file":"static/js/async/camera/page.786208dc.js","mappings":"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","sources":["webpack://my-modern-app/./src/components/ui/alert.tsx","webpack://my-modern-app/./src/routes/camera/page.tsx"],"sourcesContent":["import * as React from 'react';\nimport { cva, type VariantProps } from 'class-variance-authority';\n\nimport { cn } from '@/lib/utils';\n\nconst alertVariants = cva(\n  'relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground',\n  {\n    variants: {\n      variant: {\n        default: 'bg-background text-foreground',\n        destructive:\n          'border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive',\n      },\n    },\n    defaultVariants: {\n      variant: 'default',\n    },\n  },\n);\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n));\nAlert.displayName = 'Alert';\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn('mb-1 font-medium leading-none tracking-tight', className)}\n    {...props}\n  />\n));\nAlertTitle.displayName = 'AlertTitle';\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn('text-sm [&_p]:leading-relaxed', className)}\n    {...props}\n  />\n));\nAlertDescription.displayName = 'AlertDescription';\n\nexport { Alert, AlertTitle, AlertDescription };\n","import { useEffect, useRef, useState } from 'react';\nimport { Alert } from '@/components/ui/alert';\n\nasync function getImg(path: string): Promise<HTMLImageElement> {\n  return new Promise((resolve, reject) => {\n    const img = new Image();\n    img.src = path;\n    img.onload = () => {\n      resolve(img);\n    };\n    img.onerror = err => {\n      reject(err);\n    };\n  });\n}\n\nfunction transtion(num: number) {\n  return num * 2;\n}\n\ntype CameraType = 'user' | 'environment';\ntype StateType = {\n  isUse?: boolean;\n\n  // 闪光灯\n  track?: MediaStreamTrack | null;\n  isUseTorch?: boolean;\n  trackStatus?: boolean;\n};\ntype WatermarkType = {\n  type: string;\n  url?: string;\n  text?: string;\n  x: number;\n  y: number;\n  width?: number;\n  height?: number;\n  color?: string;\n  fontSize?: number;\n};\n\nconst watermark: WatermarkType[] = [\n  {\n    type: 'text',\n    text: '测试水印',\n    x: 10,\n    y: 10,\n    color: '#000',\n    fontSize: 20,\n  },\n];\nfunction Camera() {\n  const [state, setState] = useState<StateType>({\n    isUse: false,\n    track: null,\n    isUseTorch: false,\n    trackStatus: false,\n  });\n  const [imgUrl, setImgUrl] = useState<string>('');\n  const videoRef = useRef<HTMLVideoElement>(null);\n  const canvasBox = useRef<HTMLDivElement>(null);\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const cameraCanvasRef = useRef<HTMLCanvasElement>(null);\n  const canvas2dRef = useRef<CanvasRenderingContext2D | null>(null);\n  const cameraCanvas2dRef = useRef<CanvasRenderingContext2D | null>(null);\n\n  const [cameraExact, setCameraExact] = useState<CameraType>('environment');\n\n  const handleShutter = () => {\n    cameraCanvas2dRef.current?.drawImage(\n      videoRef.current as HTMLVideoElement,\n      0,\n      0,\n      videoRef.current?.videoWidth as number,\n      videoRef.current?.videoHeight as number,\n    );\n    const img = cameraCanvasRef.current?.toDataURL('image/png');\n    setImgUrl(img as string);\n  };\n  const handleTrach = () => {\n    setState(s => {\n      // state.track?.applyConstraints({\n      //   advanced: [{ torch: !s.trackStatus }],\n      // });\n      return {\n        trackStatus: !s.trackStatus,\n      };\n    });\n  };\n  const closeCamera = () => {\n    if (videoRef.current?.srcObject) {\n      (videoRef.current.srcObject as MediaStream).getTracks().forEach(track => {\n        track.stop();\n      });\n    }\n  };\n\n  const makeWatermark = async (ctx2d: CanvasRenderingContext2D) => {\n    if (watermark.length === 0) {\n      return;\n    }\n    for (const item of watermark) {\n      switch (item.type) {\n        case 'img': {\n          const [getImgErr, { path: imgPath }] = [false, { path: '' }];\n          if (getImgErr) {\n            throw new Error(`${item.url} 没有找到`);\n          }\n          const img = await getImg(imgPath);\n          ctx2d.drawImage(\n            img,\n            item.x,\n            item.y,\n            item.width || 0,\n            item.height || 0,\n          );\n          break;\n        }\n        case 'text': {\n          const color = item.color || '#000';\n          const fontSize = item.fontSize || 16;\n\n          ctx2d.fillStyle = color;\n          ctx2d.font = `${fontSize}px normal`;\n          item?.text && ctx2d.fillText(item.text, item.x, item.y);\n          break;\n        }\n        default:\n          // do nothing\n          break;\n      }\n    }\n  };\n  const openScan = () => {\n    const width = transtion(\n      document.documentElement.clientWidth || document.body.clientWidth,\n    );\n    const height = transtion(\n      document.documentElement.clientHeight || document.body.clientHeight,\n    );\n\n    const videoParam = {\n      audio: false,\n      video: {\n        aspectRatio: width / height,\n        facingMode: cameraExact,\n        width,\n        height,\n      },\n    };\n    navigator.mediaDevices\n      .getUserMedia(videoParam)\n      .then(stream => {\n        if (videoRef.current) {\n          videoRef.current.srcObject = stream;\n          videoRef.current.setAttribute('playsinline', 'true');\n          videoRef.current.setAttribute('webkit-playsinline', 'true');\n          videoRef.current.play();\n          makeWatermark(canvas2dRef.current as CanvasRenderingContext2D);\n          const videoTrack = stream.getVideoTracks()[0];\n          console.log('Constraints', videoTrack.getConstraints());\n          console.log('Capabilities', videoTrack.getCapabilities());\n          console.log('Settings', videoTrack.getSettings());\n\n          setState({\n            isUse: true,\n            track: stream.getVideoTracks()[0],\n          });\n          setTimeout(() => {\n            setState({\n              isUseTorch:\n                (state.track?.getCapabilities() as any)?.torch || false,\n            });\n          }, 500);\n        }\n      })\n      .catch(err => {\n        console.error('设备不支持', err);\n      });\n  };\n  useEffect(() => {\n    if (location.protocol !== 'https:') {\n      console.error('请使用https协议');\n    }\n    if (canvasRef.current) {\n      canvas2dRef.current = canvasRef.current.getContext('2d');\n    }\n    if (cameraCanvasRef.current) {\n      cameraCanvas2dRef.current = cameraCanvasRef.current?.getContext('2d');\n    }\n    openScan();\n    return () => {\n      closeCamera();\n    };\n  }, []);\n\n  const handleSwitch = () => {\n    setCameraExact(s => {\n      return s === 'environment' ? 'user' : 'environment';\n    });\n    closeCamera();\n    openScan();\n  };\n\n  return (\n    <div>\n      <div ref={canvasBox} className=\"relative\">\n        <div className=\"fixed top-2 right-2 p-2 z-20\" onClick={handleSwitch}>\n          Switch\n        </div>\n        <div className=\"trach-box\" onClick={handleTrach}>\n          trach\n        </div>\n        {imgUrl && (\n          <img className=\"fixed top-0 left-0 z-20\" src={imgUrl} alt=\"\" />\n        )}\n        <div className=\"fixed bottom-0 left-0 w-screen flex items-center justify-center bg-transparent z-40\">\n          <a\n            className=\"flex items-center justify-center w-8 h-8 rounded-full bg-slate-900 text-white\"\n            onClick={handleShutter}\n          >\n            拍\n          </a>\n        </div>\n        <video ref={videoRef} className=\"w-screen h-screen\" />\n        <canvas\n          ref={canvasRef}\n          id=\"canvas\"\n          className=\"w-screen h-screen fixed left-0 top-0\"\n        />\n        <canvas\n          ref={cameraCanvasRef}\n          id=\"camera-canvas\"\n          className=\"w-screen h-full hidden\"\n        />\n      </div>\n      <Alert>\n        <dl>\n          <dt>相机权限被拒绝，请尝试如下操作：</dt>\n          <dd>刷新页面后重试；</dd>\n          <dd>在系统中检测当前App或浏览器的相机权限是否被禁用；</dd>\n          <dd>如果依然不能体验，建议在微信中打开链接；</dd>\n        </dl>\n      </Alert>\n    </div>\n  );\n}\n\nexport default Camera;\n"],"names":["alertVariants","cva","variants","variant","default","destructive","defaultVariants","Alert","React","_ref","ref","className","props","_objectWithoutProperties","_excluded","_jsx","_objectSpread","role","cn","displayName","AlertTitle","_ref2","_excluded2","AlertDescription","_ref3","_excluded3","getImg","_x","_getImg","apply","arguments","_asyncToGenerator","path","Promise","resolve","reject","img","Image","src","onload","onerror","err","transtion","num","watermark","type","text","x","y","color","fontSize","state","setState","useState","isUse","track","isUseTorch","trackStatus","imgUrl","setImgUrl","videoRef","useRef","canvasBox","canvasRef","cameraCanvasRef","canvas2dRef","cameraCanvas2dRef","cameraExact","setCameraExact","closeCamera","_videoRef$current3","current","srcObject","getTracks","forEach","stop","makeWatermark","ctx2d","length","item","getImgErr","imgPath","Error","url","drawImage","width","height","fillStyle","font","fillText","_x2","openScan","document","documentElement","clientWidth","body","clientHeight","videoParam","audio","video","aspectRatio","facingMode","navigator","mediaDevices","getUserMedia","then","stream","setAttribute","play","videoTrack","getVideoTracks","console","log","getConstraints","getCapabilities","getSettings","setTimeout","_state$track","torch","catch","error","useEffect","_cameraCanvasRef$curr2","location","protocol","getContext","_jsxs","children","onClick","handleSwitch","s","handleTrach","alt","handleShutter","_cameraCanvas2dRef$cu","_videoRef$current","_videoRef$current2","_cameraCanvasRef$curr","videoWidth","videoHeight","toDataURL","id"],"sourceRoot":""}